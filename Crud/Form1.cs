using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.IO;
using System.Linq;
using System.Reflection;
using System.Text;
using System.Windows.Forms;
using OpenDentBusiness;

namespace Crud {
	public partial class Form1:Form {
		private string crudDir;
		private const string rn="\r\n";
		private const string t="\t";
		private const string t2="\t\t";
		private const string t3="\t\t\t";
		private const string t4="\t\t\t\t";
		private const string t5="\t\t\t\t\t";

		public Form1() {
			InitializeComponent();
		}

		private void Form1_Load(object sender,EventArgs e) {
			crudDir=@"..\..\..\OpenDentBusiness\Crud";
			if(!Directory.Exists(crudDir)) {
				MessageBox.Show(crudDir+" is an invalid path.");
				Application.Exit();
			}
		}

		private void butRun_Click(object sender,EventArgs e) {
			Cursor=Cursors.WaitCursor;
			string[] files=Directory.GetFiles(crudDir);
			//There is no reason to clear the files.  Each one will be cleared as needed.
			//for(int i=0;i<files.Length;i++) {
			//	if(checkOne.Checked && Path.GetFileNameWithoutExtension(files[i])!="Account") {
			//		continue;
			//	}
				//File.WriteAllText(files[i],"");
			//}
			Type typeTableBase=typeof(TableBase);
			Assembly assembly=Assembly.GetAssembly(typeTableBase);
			StringBuilder strb;
			CrudGenHelper.ConnectToDatabase(textDb.Text);
			foreach(Type typeClass in assembly.GetTypes()){
				if(typeClass.BaseType!=typeTableBase) {
					continue;
				}
				if(checkOne.Checked && typeClass.Name!="Account") {
					continue;
				}
				string className=typeClass.Name+"Crud";
				strb=new StringBuilder();
				CrudGenHelper.ValidateTypes(typeClass,textDb.Text);
				WriteAll(strb,className,typeClass);
				File.WriteAllText(Path.Combine(crudDir,className+".cs"),strb.ToString());
			}
			Cursor=Cursors.Default;
			MessageBox.Show("Done");
			Application.Exit();
		}

		private void butClear_Click(object sender,EventArgs e) {
			string[] files=Directory.GetFiles(crudDir);
			for(int i=0;i<files.Length;i++) {
				File.WriteAllText(files[i],"");
			}
			MessageBox.Show("Done");
			Application.Exit();
		}

		///<summary>Example of className is 'AccountCrud'.</summary>
		private void WriteAll(StringBuilder strb,string className,Type typeClass) {
			FieldInfo[] fields=typeClass.GetFields();//We can't assume they are in the correct order.
			FieldInfo priKey=CrudGenHelper.GetPriKey(fields,typeClass.Name);
			string tablename=CrudGenHelper.GetTableName(typeClass);//in lowercase now.
			string priKeyParam=priKey.Name.Substring(0,1).ToLower()+priKey.Name.Substring(1);//lowercase initial letter.  Example patNum
			string obj=typeClass.Name.Substring(0,1).ToLower()+typeClass.Name.Substring(1);//lowercase initial letter.  Example feeSched
			string oldObj="old"+typeClass.Name;//used in the second update overload.  Example oldFeeSched
			strb.Append("//This file is automatically generated."+rn//, most recently on "+DateTime.Now.ToString()+rn//Don't do this, because it forces frequent commits.
				+"//Do not attempt to make changes to this file because the changes will be erased and overwritten."+rn
				+@"using System;
using System.Collections;
using System.Collections.Generic;
using System.Data;
using System.Drawing;

namespace OpenDentBusiness.Crud{
	internal class "+className+" {");
			//SelectOne------------------------------------------------------------------------------------------
			strb.Append(rn+t2+"///<summary>Gets one "+typeClass.Name+" object from the database using the primary key.  Returns null if not found.</summary>");
			strb.Append(rn+t2+"internal static "+typeClass.Name+" SelectOne(long "+priKeyParam+"){");
			strb.Append(rn+t3+"string command=\"SELECT * FROM "+tablename+" \"");
			strb.Append(rn+t4+"+\"WHERE "+priKey.Name+" = \"+POut.Long("+priKeyParam+");");
			strb.Append(rn+t3+"List<"+typeClass.Name+"> list=TableToList(Db.GetTable(command));");
			strb.Append(rn+t3+"if(list.Count==0) {");
			strb.Append(rn+t4+"return null;");
			strb.Append(rn+t3+"}");
			strb.Append(rn+t3+"return list[0];");
			strb.Append(rn+t2+"}");
			//SelectOne(string command)--------------------------------------------------------------------------
			strb.Append(rn+rn+t2+"///<summary>Gets one "+typeClass.Name+" object from the database using a query.</summary>");
			strb.Append(rn+t2+"internal static "+typeClass.Name+" SelectOne(string command){");
			strb.Append(rn+t3+@"if(RemotingClient.RemotingRole==RemotingRole.ClientWeb) {
				throw new ApplicationException(""Not allowed to send sql directly.  Rewrite the calling class to not use this query:\r\n""+command);
			}");
			strb.Append(rn+t3+"List<"+typeClass.Name+"> list=TableToList(Db.GetTable(command));");
			strb.Append(rn+t3+"if(list.Count==0) {");
			strb.Append(rn+t4+"return null;");
			strb.Append(rn+t3+"}");
			strb.Append(rn+t3+"return list[0];");
			strb.Append(rn+t2+"}");
			//SelectMany-----------------------------------------------------------------------------------------
			strb.Append(rn+rn+t2+"///<summary>Gets one "+typeClass.Name+" object from the database using a query.</summary>");
			strb.Append(rn+t2+"internal static List<"+typeClass.Name+"> SelectMany(string command){");
			strb.Append(rn+t3+@"if(RemotingClient.RemotingRole==RemotingRole.ClientWeb) {
				throw new ApplicationException(""Not allowed to send sql directly.  Rewrite the calling class to not use this query:\r\n""+command);
			}");
			strb.Append(rn+t3+"List<"+typeClass.Name+"> list=TableToList(Db.GetTable(command));");
			strb.Append(rn+t3+"return list;");
			strb.Append(rn+t2+"}");
			//TableToList----------------------------------------------------------------------------------------
			strb.Append(rn+rn+t2+"///<summary>Converts a DataTable to a list of objects.</summary>");
			strb.Append(rn+t2+"internal static List<"+typeClass.Name+"> TableToList(DataTable table){");
			strb.Append(rn+t3+"List<"+typeClass.Name+"> retVal=new List<"+typeClass.Name+">();");
			strb.Append(rn+t3+typeClass.Name+" "+obj+";");
			strb.Append(rn+t3+"for(int i=0;i<table.Rows.Count;i++) {");
			strb.Append(rn+t4+obj+"=new "+typeClass.Name+"();");
			List<FieldInfo> fieldsInDb=CrudGenHelper.GetFieldsExceptNotDb(fields);
			//get the longest fieldname for alignment purposes
			int longestField=0;
			for(int f=0;f<fieldsInDb.Count;f++){
				if(fieldsInDb[f].Name.Length>longestField){
					longestField=fieldsInDb[f].Name.Length;
				}
			}
			for(int f=0;f<fieldsInDb.Count;f++){
				//note.  These are not guaranteed to be in any particular order.
				strb.Append(rn+t4+obj+"."+fieldsInDb[f].Name.PadRight(longestField,' ')+"= ");
				if(fieldsInDb[f].FieldType.IsEnum) {
					strb.Append("("+fieldsInDb[f].FieldType.Name+")PIn.Int(");
				}
				else switch(fieldsInDb[f].FieldType.Name){
					default:
						throw new ApplicationException("Type not yet supported: "+fieldsInDb[f].FieldType.Name);
					case "Boolean":
						strb.Append("PIn.Bool  (");
						break;
					case "Byte":
						strb.Append("PIn.Byte  (");
						break;
					case "Color":
						strb.Append("Color.FromArgb(PIn.Int(");
						break;
					case "DateTime"://This ONLY handles date, not dateT which will be a special type.
						strb.Append("PIn.Date  (");
						break;
					case "Double":
						strb.Append("PIn.Double(");
						break;
					case "Int64":
						strb.Append("PIn.Long  (");
						break;
					case "Int32":
						strb.Append("PIn.Int   (");
						break;
					case "String":
						strb.Append("PIn.String(");
						break;
					case "TimeSpan":
						strb.Append("PIn.TimeSpan(");
						break;
				}
				strb.Append("table.Rows[i][\""+fieldsInDb[f].Name+"\"].ToString())");
				if(fieldsInDb[f].FieldType.Name=="Color") {
					strb.Append(")");
				}
				strb.Append(";");
			}
			strb.Append(rn+t4+"retVal.Add("+obj+");");
			strb.Append(rn+t3+"}");
			strb.Append(rn+t3+"return retVal;");
			strb.Append(rn+t2+"}");
			//Insert---------------------------------------------------------------------------------------------
			strb.Append(rn+rn+t2+"///<summary>Inserts one "+typeClass.Name+" into the database.  Returns the new priKey.</summary>");
			strb.Append(rn+t2+"internal static long Insert("+typeClass.Name+" "+obj+"){");
			strb.Append(rn+t3+"return Insert("+obj+",false);");
			strb.Append(rn+t2+"}");
			//second override
			strb.Append(rn+rn+t2+"///<summary>Inserts one "+typeClass.Name+" into the database.  Provides option to use the existing priKey.</summary>");
			strb.Append(rn+t2+"internal static long Insert("+typeClass.Name+" "+obj+",bool useExistingPK){");
			strb.Append(rn+t3+"if(!useExistingPK && PrefC.RandomKeys) {");
			strb.Append(rn+t4+obj+"."+priKey.Name+"=ReplicationServers.GetKey(\""+tablename+"\",\""+priKey.Name+"\");");
			strb.Append(rn+t3+"}");
			strb.Append(rn+t3+"string command=\"INSERT INTO "+tablename+" (\";");
			strb.Append(rn+t3+"if(useExistingPK || PrefC.RandomKeys) {");
			strb.Append(rn+t4+"command+=\""+priKey.Name+",\";");
			strb.Append(rn+t3+"}");
			strb.Append(rn+t3+"command+=\"");
			List<FieldInfo> fieldsExceptPri=CrudGenHelper.GetFieldsExceptPriKey(fields,priKey);
			for(int f=0;f<fieldsExceptPri.Count;f++) {
				if(CrudGenHelper.GetSpecialType(fieldsExceptPri[f])==EnumCrudSpecialColType.TimeStamp) {
					continue;
				}
				if(f>0) {
					strb.Append(",");
				}
				strb.Append(fieldsExceptPri[f].Name);
			}
			strb.Append(") VALUES(\";");
			strb.Append(rn+t3+"if(useExistingPK || PrefC.RandomKeys) {");
			strb.Append(rn+t4+"command+=POut.Long("+obj+"."+priKey.Name+")+\",\";");
			strb.Append(rn+t3+"}");
			strb.Append(rn+t3+"command+=");
			EnumCrudSpecialColType specialType;
			for(int f=0;f<fieldsExceptPri.Count;f++) {
				strb.Append(rn+t4);
				specialType=CrudGenHelper.GetSpecialType(fieldsExceptPri[f]);
				if(specialType==EnumCrudSpecialColType.TimeStamp) {
					strb.Append("//"+fieldsExceptPri[f].Name+" can only be set by MySQL");
					continue;
				}
				if(f==0) {
					strb.Append(" ");
				}
				else {
					strb.Append("+");
				}
				if(specialType==EnumCrudSpecialColType.DateEntry) {
					strb.Append("\"NOW()");
				}
				else if(fieldsExceptPri[f].FieldType.IsEnum) {
					strb.Append("    POut.Int   ((int)"+obj+"."+fieldsExceptPri[f].Name+")+\"");
				}
				else switch(fieldsExceptPri[f].FieldType.Name) {
					default:
						throw new ApplicationException("Type not yet supported: "+fieldsExceptPri[f].FieldType.Name);
					case "Boolean":
						strb.Append("    POut.Bool  ("+obj+"."+fieldsExceptPri[f].Name+")+\"");
						break;
					case "Byte":
						strb.Append("    POut.Byte  ("+obj+"."+fieldsExceptPri[f].Name+")+\"");
						break;
					case "Color":
						strb.Append("    POut.Int   ("+obj+"."+fieldsExceptPri[f].Name+".ToArgb())+\"");
						break;
					case "DateTime"://Need to handle DateT fields here better.
						strb.Append("    POut.Date  ("+obj+"."+fieldsExceptPri[f].Name+")+\"");
						break;
					case "Double":
						strb.Append("\"'\"+POut.Double("+obj+"."+fieldsExceptPri[f].Name+")+\"'");
						break;
					case "Int64":
						strb.Append("    POut.Long  ("+obj+"."+fieldsExceptPri[f].Name+")+\"");
						break;
					case "Int32":
						strb.Append("    POut.Int   ("+obj+"."+fieldsExceptPri[f].Name+")+\"");
						break;
					case "String":
						strb.Append("\"'\"+POut.String("+obj+"."+fieldsExceptPri[f].Name+")+\"'");
						break;
					case "TimeSpan":
						strb.Append("    POut.TimeSpan("+obj+"."+fieldsExceptPri[f].Name+")+\"");
						break;
				}
				if(f==fieldsExceptPri.Count-2
					&& CrudGenHelper.GetSpecialType(fieldsExceptPri[f+1])==EnumCrudSpecialColType.TimeStamp) 
				{
					//in case the last field is a timestamp
					strb.Append(")\";");
				}
				else if(f<fieldsExceptPri.Count-1) {
					strb.Append(",\"");
				}
				else {
					strb.Append(")\";");
				}
			} 
			strb.Append(rn+t3+"if(useExistingPK || PrefC.RandomKeys) {");
			strb.Append(rn+t4+"Db.NonQ(command);");
			strb.Append(rn+t3+"}");
			strb.Append(rn+t3+"else {");
			strb.Append(rn+t4+obj+"."+priKey.Name+"=Db.NonQ(command,true);");
			strb.Append(rn+t3+"}");
			strb.Append(rn+t3+"return "+obj+"."+priKey.Name+";");
			strb.Append(rn+t2+"}");
			//Update---------------------------------------------------------------------------------------------
			strb.Append(rn+rn+t2+"///<summary>Updates one "+typeClass.Name+" in the database.</summary>");
			strb.Append(rn+t2+"internal static void Update("+typeClass.Name+" "+obj+"){");
			strb.Append(rn+t3+"string command=\"UPDATE "+tablename+" SET \"");
			for(int f=0;f<fieldsExceptPri.Count;f++) {
				specialType=CrudGenHelper.GetSpecialType(fieldsExceptPri[f]);
				if(specialType==EnumCrudSpecialColType.DateEntry) {
					strb.Append(rn+t4+"//"+fieldsExceptPri[f].Name+" not allowed to change");
					continue;
				}
				if(specialType==EnumCrudSpecialColType.TimeStamp) {
					strb.Append(rn+t4+"//"+fieldsExceptPri[f].Name+" can only be set by MySQL");
					continue;
				}
				strb.Append(rn+t4+"+\""+fieldsExceptPri[f].Name.PadRight(longestField,' ')+"= ");
				if(fieldsExceptPri[f].FieldType.IsEnum) {
					strb.Append(" \"+POut.Int   ((int)"+obj+"."+fieldsExceptPri[f].Name+")+\"");
				}
				else switch(fieldsExceptPri[f].FieldType.Name) {
					default:
						throw new ApplicationException("Type not yet supported: "+fieldsExceptPri[f].FieldType.Name);
					case "Boolean":
						strb.Append(" \"+POut.Bool  ("+obj+"."+fieldsExceptPri[f].Name+")+\"");
						break;
					case "Byte":
						strb.Append(" \"+POut.Byte  ("+obj+"."+fieldsExceptPri[f].Name+")+\"");
						break;
					case "Color":
						strb.Append(" \"+POut.Int   ("+obj+"."+fieldsExceptPri[f].Name+".ToArgb())+\"");
						break;
					case "DateTime"://Need to handle DateT fields here better.
						strb.Append(" \"+POut.Date  ("+obj+"."+fieldsExceptPri[f].Name+")+\"");
						break;
					case "Double":
						strb.Append("'\"+POut.Double("+obj+"."+fieldsExceptPri[f].Name+")+\"'");
						break;
					case "Int64":
						strb.Append(" \"+POut.Long  ("+obj+"."+fieldsExceptPri[f].Name+")+\"");
						break;
					case "Int32":
						strb.Append(" \"+POut.Int   ("+obj+"."+fieldsExceptPri[f].Name+")+\"");
						break;
					case "String":
						strb.Append("'\"+POut.String("+obj+"."+fieldsExceptPri[f].Name+")+\"'");
						break;
					case "TimeSpan":
						strb.Append(" \"+POut.TimeSpan("+obj+"."+fieldsExceptPri[f].Name+")+\"");
						break;
				}
				if(f==fieldsExceptPri.Count-2
					&& CrudGenHelper.GetSpecialType(fieldsExceptPri[f+1])==EnumCrudSpecialColType.TimeStamp) 
				{
					//in case the last field is a timestamp
					//strb.Append(" \"");
				}
				else if(f<fieldsExceptPri.Count-1) {
					strb.Append(",");
				}
				strb.Append(" \"");
			}
			strb.Append(rn+t4+"+\"WHERE "+priKey.Name+" = \"+POut.Long("+obj+"."+priKey.Name+");");
			strb.Append(rn+t3+"Db.NonQ(command);");
			strb.Append(rn+t2+"}");
			//Update, 2nd override-------------------------------------------------------------------------------
			strb.Append(rn+rn+t2+"///<summary>Updates one "+typeClass.Name+" in the database.  Uses an old object to compare to, and only alters changed fields.  This prevents collisions and concurrency problems in heavily used tables.</summary>");
			strb.Append(rn+t2+"internal static void Update("+typeClass.Name+" "+obj+","+typeClass.Name+" "+oldObj+"){");
			strb.Append(rn+t3+"string command=\"\";");
			for(int f=0;f<fieldsExceptPri.Count;f++) {
				specialType=CrudGenHelper.GetSpecialType(fieldsExceptPri[f]);
				if(specialType==EnumCrudSpecialColType.DateEntry) {
					strb.Append(rn+t3+"//"+fieldsExceptPri[f].Name+" not allowed to change");
					continue;
				}
				if(specialType==EnumCrudSpecialColType.TimeStamp) {
					strb.Append(rn+t3+"//"+fieldsExceptPri[f].Name+" can only be set by MySQL");
					continue;
				}
				strb.Append(rn+t3+"if("+obj+"."+fieldsExceptPri[f].Name+" != "+oldObj+"."+fieldsExceptPri[f].Name+") {");
				strb.Append(rn+t4+"if(command!=\"\"){ command+=\",\";}");
				strb.Append(rn+t4+"command+=\""+fieldsExceptPri[f].Name+" = ");
				if(fieldsExceptPri[f].FieldType.IsEnum) {
					strb.Append("\"+POut.Int   ((int)"+obj+"."+fieldsExceptPri[f].Name+")+\"");
				}
				else switch(fieldsExceptPri[f].FieldType.Name) {
					default:
						throw new ApplicationException("Type not yet supported: "+fieldsExceptPri[f].FieldType.Name);
					case "Boolean":
						strb.Append("\"+POut.Bool("+obj+"."+fieldsExceptPri[f].Name+")+\"");
						break;
					case "Byte":
						strb.Append("\"+POut.Byte("+obj+"."+fieldsExceptPri[f].Name+")+\"");
						break;
					case "Color":
						strb.Append("\"+POut.Int("+obj+"."+fieldsExceptPri[f].Name+".ToArgb())+\"");
						break;
					case "DateTime"://Need to handle DateT fields here better.
						strb.Append("\"+POut.Date("+obj+"."+fieldsExceptPri[f].Name+")+\"");
						break;
					case "Double":
						strb.Append("'\"+POut.Double("+obj+"."+fieldsExceptPri[f].Name+")+\"'");
						break;
					case "Int64":
						strb.Append("\"+POut.Long("+obj+"."+fieldsExceptPri[f].Name+")+\"");
						break;
					case "Int32":
						strb.Append("\"+POut.Int("+obj+"."+fieldsExceptPri[f].Name+")+\"");
						break;
					case "String":
						strb.Append("'\"+POut.String("+obj+"."+fieldsExceptPri[f].Name+")+\"'");
						break;
					case "TimeSpan":
						strb.Append("\"+POut.TimeSpan("+obj+"."+fieldsExceptPri[f].Name+")+\"");
						break;
				}
				strb.Append("\";");
				strb.Append(rn+t3+"}");
			}
			strb.Append(rn+t3+"if(command==\"\"){");
			strb.Append(rn+t4+"return;");
			strb.Append(rn+t3+"}");
			strb.Append(rn+t3+"command=\"UPDATE "+tablename+" SET \"+command");
			strb.Append(rn+t4+"+\" WHERE "+priKey.Name+" = \"+POut.Long("+obj+"."+priKey.Name+");");
			strb.Append(rn+t3+"Db.NonQ(command);");
			strb.Append(rn+t2+"}");
			//Delete---------------------------------------------------------------------------------------------
			if(CrudGenHelper.IsDeleteForbidden(typeClass)) {
				strb.Append(rn+rn+t2+"//Delete not allowed for this table");
				strb.Append(rn+t2+"//internal static void Delete(long "+priKeyParam+"){");
				strb.Append(rn+t2+"//");
				strb.Append(rn+t2+"//}");
			}
			else {
				strb.Append(rn+rn+t2+"///<summary>Deletes one "+typeClass.Name+" from the database.</summary>");
				strb.Append(rn+t2+"internal static void Delete(long "+priKeyParam+"){");
				strb.Append(rn+t3+"string command=\"DELETE FROM "+tablename+" \"");
				strb.Append(rn+t4+"+\"WHERE "+priKey.Name+" = \"+POut.Long("+priKeyParam+");");
				strb.Append(rn+t3+"Db.NonQ(command);");
				strb.Append(rn+t2+"}");
			}
			//Footer
			strb.Append(@"
	}
}");
		}


	}
}
