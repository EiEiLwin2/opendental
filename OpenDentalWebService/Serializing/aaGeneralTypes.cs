using System;
using System.Collections.Generic;
using System.Data;
using System.IO;
using System.Text;
using System.Xml;
using System.Text.RegularExpressions;
using System.Collections;

namespace OpenDentalWebService {
	///<summary>This file is NOT generated automatically by the crud, you must manually make changes to this file.  However, the methods in this class will most likely get called from classes generated by the crud.  Make sure the necessary changes to the crud have been made.  The "Primitive and General Types" region of Remoting.DtoMethods.CallClassDeserializer() is an example where a crud enhancement would need to take place if adding a type to this file.</summary>
	public static class aaGeneralTypes {

		///<summary>Goes through all the possible types of objects and returns the object serialized for Java.  objectType must be fully qualified.  Ex: System.Int32.  For DataTables, set objectType to "DataTable".  Returns an empty node if the object is null.  Throws exceptions.</summary>
		public static string Serialize(string objectType,Object obj) {
			if(obj==null) {
				return "<"+objectType+"/>";//Return an empty node?
			}
			//Primitives--------------------------------------------------------------------
			if(objectType=="System.Int32" || objectType=="int") {
				return "<int>"+OpenDentBusiness.POut.Int((int)obj)+"</int>";
			}
			if(objectType=="System.Int64" || objectType=="long") {//Web app does not use longs.
				//The largest possible value of an Int32 is 2,147,483,647.  An OverflowException will occur if the long is too big for the web version.
				return "<int>"+Convert.ToInt32(((long)obj)).ToString()+"</int>";
			}
			if(objectType=="System.Boolean" || objectType=="bool") {
				return "<boolean>"+OpenDentBusiness.POut.Bool((bool)obj)+"</boolean>";
			}
			if(objectType=="System.String" || objectType=="string") {
				return "<String>"+OpenDentBusiness.POut.String((string)obj)+"</String>";
			}
			if(objectType=="System.Char" || objectType=="char") {
				return "<char>"+Convert.ToChar((char)obj).ToString()+"</char>";
			}
			if(objectType=="System.Single" || objectType=="Single") {
				return "<float>"+OpenDentBusiness.POut.Float((float)obj)+"</float>";
			}
			if(objectType=="System.Byte" || objectType=="byte") {
				return "<byte>"+OpenDentBusiness.POut.Byte((byte)obj)+"</byte>";
			}
			if(objectType=="System.Double" || objectType=="double") {
				return "<double>"+OpenDentBusiness.POut.Double((double)obj)+"</double>";
			}
			//DataTable---------------------------------------------------------------------
			if(objectType=="DataTable") {
				return SerializeDataTable((DataTable)obj);
			}
			throw new NotSupportedException("Serialize, unsupported primitive or general type: "+objectType);
		}

		///<summary>Returns the primitive or general object deserialized.  Throws exception.</summary>
		public static object Deserialize(string typeName,string xml) {
			try {
				using(XmlReader reader=XmlReader.Create(new StringReader(xml))) {
					while(reader.Read()) {//In a loop just in case there is whitespace and it needs to read more than once.  Shouldn't need to loop more than once.
						//Primitives--------------------------------------------------------------------
						switch(reader.Name) {
							case "int":
								return OpenDentBusiness.PIn.Int(reader.ReadString());
							case "long":
								return OpenDentBusiness.PIn.Long(reader.ReadString());
							case "bool":
								return OpenDentBusiness.PIn.Bool(reader.ReadString());
							case "string":
								return OpenDentBusiness.PIn.String(reader.ReadString());
							case "char":
								return Convert.ToChar(reader.ReadString());
							case "float":
								return OpenDentBusiness.PIn.Float(reader.ReadString());
							case "byte":
								return OpenDentBusiness.PIn.Byte(reader.ReadString());
							case "double":
								return OpenDentBusiness.PIn.Double(reader.ReadString());
							case "DateTime":
								return OpenDentBusiness.PIn.DateT(reader.ReadString());
						}
						//List<?>-----------------------------------------------------------------------
						if(typeName.StartsWith("List&lt;")) {
							return "";//Not sure how to handle lists of objects without reflection just yet...
						}
						//Arrays------------------------------------------------------------------------
						if(typeName.Contains("[")) {
							return "";//TODO: This will need to be enhanced to handle simple and possibly multidimensional arrays.
						}
					}
				}
			}
			catch {
				throw new NotSupportedException("Deserialize, error deserializing primitive or general type: "+typeName);
			}
			//Type must not be supported yet.
			throw new NotSupportedException("Deserialize, unsupported primitive or general type: "+typeName);
		}

		///<summary>Helper function that will serialize a data table by looping through the rows and columns.</summary>
		private static string SerializeDataTable(DataTable table) {
			StringBuilder result=new StringBuilder();
			result.Append("<DataTable>");
			//Table name.
			result.Append("<Name>").Append(table.TableName).Append("</Name>");
			//Column names.
			result.Append("<Cols>");
			for(int i=0;i<table.Columns.Count;i++) {
				result.Append("<Col>").Append(table.Columns[i].ColumnName).Append("</Col>");
			}
			result.Append("</Cols>");
			//Set each cell by looping through each column row by row.
			result.Append("<Cells>");
			for(int i=0;i<table.Rows.Count;i++) {//Row loop.
				result.Append("<y>");
				for(int j=0;j<table.Columns.Count;j++) {//Column loop.
					string content=table.Rows[i][j].ToString();
					if(content.Trim()=="") {//Test if the element will be empty, this will save space on big DataTables.
 						result.Append("<x/>");
					}
					else {
						result.Append("<x>").Append(SerializeStringEscapes.EscapeForXml(table.Rows[i][j].ToString())).Append("</x>");
					}
				}
				result.Append("</y>");
			}
			result.Append("</Cells>");
			result.Append("</DataTable>");
			return result.ToString();
		}

		///<summary>Pass in the type of list and the list object and this method will serialize it.  The object within the list must be fully qualified.</summary>
		public static string SerializeList(string objectType,Object obj) {
			string listType="";
			//Strip out what kind of objects this list contains.
			Match m=Regex.Match(objectType,@"^List%3C([a-zA-Z0-9._%+-]*)%3E$");
			if(!m.Success) {
				throw new Exception("SerializeList, unknown object list: "+objectType);
			}
			listType=m.Result("$1");
			//Cast to a list of objects and loop through all the objects and call each objects corresponding serialize method.
			StringBuilder result=new StringBuilder();
			result.Append("<List>");
			IEnumerable enumerable=obj as IEnumerable;
			if(enumerable!=null) {
				foreach(object item in enumerable) {
					result.Append(DtoMethods.CallClassSerializer(listType,item));
				}
			}
			result.Append("</List>");
			return result.ToString();
		}

		///<summary>Helper function that will serialize any array.</summary>
		public static string SerializeArray(string typeName,Object obj) {
			//TODO Enhance to handle serializing arrays.
			throw new Exception("SerializeArray, arrays not supported yet.");
		}





	}
}